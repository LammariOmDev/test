<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>M√©dicaments √† Conditions Particuli√®res - LammariOmDev¬Æ</title>
    <meta name="description" content="Liste des m√©dicaments √† conditions particuli√®res de remboursement (CPR) avec recherche et d√©tails.">

    <link rel="icon" type="image/png" href="favicon.png">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.bootstrap5.min.css" rel="stylesheet">

    <style>
        :root{
            --bg-start: #e9f7ef;
            --bg-end: #dff3e9;
            --card-bg: #ffffff;
            --green-1: #2ea56a;
            --green-2: #4cd27f;
            --muted: #7f8c8d;
        }

        html,body{
            height:100%;
            margin:0;
        }

        body {
            padding: 30px;
            background: linear-gradient(135deg, #a6d8b8 0%, #7ed08f 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
        }

        /* Card wrapper similar to the screenshot - centered with big rounded corners */
        .app-card {
            max-width: 1180px;
            margin: 0 auto;
            background: var(--card-bg);
            border-radius: 14px;
            box-shadow: 0 20px 40px rgba(18, 60, 30, 0.15);
            overflow: hidden;
        }

        /* Hero/header with gradient (green instead of purple) */
        .hero {
            background: linear-gradient(90deg, var(--green-1), var(--green-2));
            color: white;
            padding: 34px 36px;
            text-align: center;
            position: relative;
        }
        .hero .logo-pill{
            width:44px;
            height:44px;
            display:inline-flex;
            align-items:center;
            justify-content:center;
            border-radius:12px;
            margin-right:10px;
            background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.05) 100%);
            box-shadow: 0 6px 18px rgba(24,112,66,0.15);
            vertical-align:middle;
            font-size:20px;
        }

        .hero h1 {
            margin:0;
            font-size:32px;
            font-weight:700;
            display:inline-block;
            vertical-align:middle;
        }
        .hero p {
            margin:6px 0 0;
            opacity:0.95;
            font-size:14px;
        }

        .hero .hero-right {
            position:absolute;
            right:20px;
            top:18px;
            color:rgba(255,255,255,0.9);
            font-size:13px;
        }

        /* Controls area (search + per-page) */
        .controls {
            padding: 18px 28px;
            display:flex;
            gap:16px;
            align-items:center;
            justify-content:space-between;
            border-bottom: 1px solid #eef3ef;
        }
        .controls .search-wrap {
            flex:1 1 auto;
        }
        .input-search {
            width:100%;
            display:flex;
            align-items:center;
            gap:10px;
            background:#fbfffb;
            border-radius:10px;
            padding:12px 14px;
            box-shadow: inset 0 1px 0 rgba(0,0,0,0.02);
            border:1px solid rgba(34,139,84,0.08);
        }
        .input-search svg { width:18px; height:18px; flex:0 0 18px; color:var(--green-1); }
        .input-search input {
            border:0;
            outline:none;
            background:transparent;
            font-size:15px;
            color:#2c3e50;
        }

        .controls .right-controls {
            display:flex;
            gap:12px;
            align-items:center;
        }
        .controls label { margin:0 8px 0 0; font-size:14px; color:#4e6b57; }

        /* Counts bar */
        .counts {
            background: linear-gradient(180deg, #f4fcf6 0%, #eef8ee 100%);
            padding:10px 28px;
            color:#2c5d3e;
            font-size:14px;
            border-bottom:1px solid #edf6ef;
            display:flex;
            justify-content:space-between;
            align-items:center;
        }

        /* Table area */
        .table-area {
            padding:22px 28px 36px 28px;
        }
        table.dataTable thead {
            background: var(--green-1);
            color: #fff;
            border:none;
        }
        table.dataTable.fixedHeader-floating thead {
            background: var(--green-1) !important;
            color: #fff !important;
        }
        table.dataTable thead th {
            font-weight:700;
            padding:14px 18px;
            text-align:left;
            color: #fff;
        }
        table.dataTable tbody td {
            padding:18px;
            vertical-align:middle;
            color:#344b3a;
        }
        table.dataTable tbody tr:nth-child(even) {
            background: #fff;
        }
        table.dataTable tbody tr:nth-child(odd) {
            background: #fbfffb;
        }

        /* D√©tails button - green pill with subtle gradient and shadow */
        .btn-details {
            background: linear-gradient(180deg, #6fe09a, #2ea56a);
            border: none;
            color: white;
            padding:8px 12px;
            border-radius:10px;
            display:inline-flex;
            gap:8px;
            align-items:center;
            box-shadow: 0 6px 18px rgba(46,165,106,0.18);
            font-weight:600;
            font-size:13px;
        }
        .btn-details svg { width:16px; height:16px; }

        /* Modal styles */
        .modal-header {
            background: linear-gradient(90deg, var(--green-1), var(--green-2));
            color:white;
        }

        /* Responsive adjustments */
        @media (max-width: 900px) {
            .hero h1 { font-size:22px; }
            .controls { flex-direction:column; align-items:stretch; gap:12px; }
            .controls .right-controls { justify-content:flex-end; }
            .hero .hero-right { display:none; }
        }
    </style>
</head>
<body>

<noscript>
    <div class="alert alert-warning text-center">JavaScript est n√©cessaire pour afficher ce tableau. Veuillez activer JavaScript.</div>
</noscript>

<div class="app-card" role="main" aria-labelledby="main-title">
    <div class="hero" role="banner">
        <div class="logo-pill" aria-hidden="true">üíä</div>
        <h1 id="main-title">M√©dicaments CPR</h1>
        <p>Conditions Particuli√®res de Remboursement</p>
        <div class="hero-right">¬©2025 by LammariOmDev¬Æ</div>
    </div>

    <div class="controls" role="region" aria-label="Contr√¥les de recherche et affichage">
        <div class="search-wrap">
            <div class="input-search" aria-hidden="false">
                <!-- loupe SVG -->
                <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="10.5" cy="10.5" r="5.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                <input id="searchInput" type="search" placeholder="Rechercher dans la base de donn√©es..." aria-label="Recherche dans la base de donn√©es">
            </div>
        </div>

        <div class="right-controls" aria-hidden="false">
            <div class="form-inline">
                <label for="perPageSelect">Lignes par page:</label>
                <select id="perPageSelect" class="form-select form-select-sm" style="width:100px;">
                    <option>20</option>
                    <option>50</option>
                    <option selected>100</option>
                    <option>200</option>
                    <option>500</option>
                </select>
            </div>
        </div>
    </div>

    <div class="counts" aria-live="polite">
        <div>Total: <strong id="total-count">1 227</strong> m√©dicaments</div>
        <div>Affich√©s: <strong id="display-count">1 227</strong> r√©sultats</div>
    </div>

    <div class="table-area">
        <div class="table-responsive" aria-hidden="false">
            <table id="monTableau" class="table table-borderless table-hover" style="width:100%;">
                <caption id="table-caption" class="visually-hidden">Tableau des m√©dicaments et conditions de remboursement</caption>
                <thead>
                    <tr id="table-headers"></tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="modal-title" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modal-title">D√©tails de la Condition</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body" id="modal-content-body"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>

<script>
    let tableInstance = null;
    let myModal = null;

    document.addEventListener('DOMContentLoaded', () => {
        myModal = new bootstrap.Modal(document.getElementById('detailModal'));
        // On lie le champ de recherche personnalis√© √† DataTables plus bas apr√®s initialisation
        loadExcel('cpr.xlsx');
    });

    async function loadExcel(file) {
        const tableEl = document.getElementById('monTableau');
        const headerRow = document.getElementById('table-headers');
        const body = document.getElementById('table-body');

        // cleanup existing table
        if ($.fn.DataTable.isDataTable('#monTableau')) {
            $('#monTableau').DataTable().destroy();
            headerRow.innerHTML = '';
            body.innerHTML = '';
        }

        try {
            const response = await fetch(file + '?t=' + new Date().getTime());
            if (!response.ok) throw new Error("Fichier introuvable");

            const arrayBuffer = await response.arrayBuffer();
            const workbook = XLSX.read(new Uint8Array(arrayBuffer), { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });

            if (jsonData.length === 0) {
                throw new Error("Feuille vide");
            }

            const headers = jsonData[0].map(h => (h||'').toString());
            headers.forEach(h => {
                const th = document.createElement('th');
                th.scope = 'col';
                th.textContent = h || '-';
                headerRow.appendChild(th);
            });

            for (let i = 1; i < jsonData.length; i++) {
                const rowData = jsonData[i];
                const hasContent = rowData.some(cell => String(cell).trim() !== '');
                if (!hasContent) continue;

                const tr = document.createElement('tr');
                const drugName = rowData[0] !== undefined ? String(rowData[0]) : "M√©dicament";

                headers.forEach((_, index) => {
                    const td = document.createElement('td');
                    const cellContent = rowData[index] !== undefined ? String(rowData[index]) : '';
                    const currentHeaderName = (headers[index] || '').toString().trim().toUpperCase();

                    if ((currentHeaderName === "CPR" || currentHeaderName === "CONDITIONS") && cellContent.trim() !== "") {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'btn-details';
                        btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 4v8" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M20 21H4" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg><span>D√©tails</span>`;
                        btn.addEventListener('click', () => {
                            document.getElementById('modal-content-body').textContent = cellContent;
                            document.getElementById('modal-title').textContent = drugName;
                            myModal.show();
                        });
                        td.appendChild(btn);
                    } else {
                        td.textContent = cellContent;
                    }
                    tr.appendChild(td);
                });

                body.appendChild(tr);
            }

            // Init DataTable
            tableInstance = $('#monTableau').DataTable({
                fixedHeader: true,
                language: {
                    processing:     "Traitement en cours...",
                    search:         "Rechercher&nbsp;:",
                    lengthMenu:     "Afficher : _MENU_  lignes",
                    info:           "Affichage de _START_ √† _END_ sur _TOTAL_ √©l√©ments",
                    infoEmpty:      "Affichage de 0 √† 0 sur 0 √©l√©ments",
                    infoFiltered:   "(filtr√© de _MAX_ √©l√©ments au total)",
                    loadingRecords: "Chargement en cours...",
                    zeroRecords:    "Aucun √©l√©ment √† afficher",
                    emptyTable:     "Aucune donn√©e disponible dans le tableau",
                    paginate: {
                        first:      "Premier",
                        previous:   "Pr√©c√©dent",
                        next:       "Suivant",
                        last:       "Dernier"
                    }
                },
                pageLength: parseInt(document.getElementById('perPageSelect').value || 100, 10),
                lengthChange: false,
                order: []
            });

            // wire up our custom search input and per-page select
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', function() {
                tableInstance.search(this.value).draw();
                updateCounts();
            });

            document.getElementById('perPageSelect').addEventListener('change', function(){
                const val = parseInt(this.value, 10) || 100;
                tableInstance.page.len(val).draw();
                updateCounts();
            });

            // update counts
            function updateCounts(){
                document.getElementById('total-count').textContent = tableInstance.rows().count().toLocaleString();
                document.getElementById('display-count').textContent = tableInstance.rows({filter:'applied'}).count().toLocaleString();
            }
            updateCounts();

        } catch (error) {
            console.error("Erreur:", error);
            document.getElementById('table-body').innerHTML = `<tr><td colspan="20"><div class="alert alert-danger">Erreur : Impossible de charger le fichier ${file}.</div></td></tr>`;
        }
    }
</script>
</body>
</html>
